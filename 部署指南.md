# 学生综合素质评价系统 - 生产环境部署指南

> 本文档指导如何在学校服务器上部署完整的生产环境

---

## 📋 部署前准备清单

### 硬件要求
- **CPU**: 4核心或以上
- **内存**: 8GB或以上推荐
- **硬盘**: 100GB可用空间（包含数据库）
- **网络**: 稳定的局域网或互联网连接
- **扫描仪**: USB扫描仪（用于书法作品采集）

### 软件环境
- **操作系统**: Windows Server 2016+ 或 Linux (Ubuntu 20.04+/CentOS 8+)
- **Python**: 3.9 或更高版本
- **Node.js**: 16 LTS 或更高版本
- **MySQL**: 8.0 或更高版本
- **Nginx**: 1.18 或更高版本 (可选，用于反向代理)

### 网络配置
- 确保服务器可被校园网内设备访问
- 配置防火墙允许必要端口（3000, 8000, 3306）

---

## 📦 步骤1: 系统环境准备

### Windows Server环境

#### 1.1 安装Python

```powershell
# 下载Python 3.9+安装包
# https://www.python.org/downloads/

# 安装时勾选 "Add Python to PATH"

# 验证安装
python --version
pip --version
```

#### 1.2 安装Node.js

```powershell
# 下载Node.js LTS版本
# https://nodejs.org/

# 验证安装
node --version
npm --version
```

#### 1.3 安装MySQL

```powershell
# 下载MySQL 8.0
# https://dev.mysql.com/downloads/mysql/

# 安装过程中记住设置的root密码
# 选择默认端口 3306

# 启动MySQL服务
net start MySQL80
```

### Linux (Ubuntu) 环境

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Python 3.9+
sudo apt install python3.9 python3-pip python3-venv -y

# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt install -y nodejs

# 安装MySQL
sudo apt install mysql-server -y
sudo mysql_secure_installation

# 安装Nginx（可选）
sudo apt install nginx -y

# 验证安装
python3 --version
node --version
mysql --version
```

---

## 🗄️ 步骤2: 数据库初始化

### 2.1 创建数据库

```bash
# 登录MySQL
mysql -u root -p

# 在MySQL中执行
CREATE DATABASE calligraphy_ai CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建专用用户（生产环境推荐）
CREATE USER 'eval_admin'@'localhost' IDENTIFIED BY '强密码@2024';
GRANT ALL PRIVILEGES ON calligraphy_ai.* TO 'eval_admin'@'localhost';
FLUSH PRIVILEGES;

# 退出
EXIT;
```

### 2.2 导入数据库结构

```bash
# 进入项目目录
cd /path/to/AI Calligraphy

# 导入完整数据库结构
mysql -u root -p calligraphy_ai < database/init_full.sql

# 验证表是否创建成功
mysql -u root -p -e "USE calligraphy_ai; SHOW TABLES;"
```

### 2.3 创建初始管理员账号

```bash
# 登录MySQL
mysql -u root -p calligraphy_ai

# 插入管理员账号（密码: admin123，已bcrypt加密）
INSERT INTO users (username, password_hash, role, real_name, created_at) 
VALUES ('admin', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5NU0hVZpEy.1a', 'admin', '系统管理员', NOW());

# 退出
EXIT;
```

---

##  步骤3: 后端部署

### 3.1 复制项目文件

```bash
# Windows
xcopy /E /I "C:\项目源码" "D:\Production\AI-Calligraphy"

# Linux
cp -r /path/to/source /opt/ai-calligraphy
cd /opt/ai-calligraphy
```

### 3.2 创建Python虚拟环境

```bash
# Windows
cd D:\Production\AI-Calligraphy
python -m venv venv
venv\Scripts\activate

# Linux
cd /opt/ai-calligraphy
python3 -m venv venv
source venv/bin/activate
```

### 3.3 安装Python依赖

```bash
# 确保在虚拟环境中
pip install --upgrade pip
pip install -r requirements.txt

# 验证关键依赖
pip list | grep fastapi
pip list | grep mysql-connector
```

### 3.4 配置后端

编辑 `src/web/auth/dependencies.py`:

```python
# 数据库配置
DB_CONFIG = {
    'host': 'localhost',
    'user': 'eval_admin',          # 使用专用用户
    'password': '强密码@2024',     # 实际密码
    'database': 'calligraphy_ai',
    'charset': 'utf8mb4',
    'pool_size': 10,               # 连接池大小
    'pool_recycle': 3600           # 连接回收时间
}
```

编辑 `src/api/qwen_client.py`:

```python
# 千问API配置
QWEN_API_KEY = "sk-实际的API密钥"  # 联系阿里云获取
```

### 3.5 测试后端启动

```bash
# 开发模式测试
python run_web.py
# 访问 http://localhost:8000/docs 检查API文档

# 如果正常，Ctrl+C 停止
```

### 3.6 配置生产环境启动（使用Gunicorn）

```bash
# 安装Gunicorn
pip install gunicorn uvicorn[standard]

# 创建启动脚本 start_backend.sh (Linux)
cat > start_backend.sh << 'EOF'
#!/bin/bash
source venv/bin/activate
gunicorn -w 4 -k uvicorn.workers.UvicornWorker \
    --bind 0.0.0.0:8000 \
    --access-logfile logs/access.log \
    --error-logfile logs/error.log \
    --log-level info \
    src.web.app:app
EOF

chmod +x start_backend.sh

# Windows: 创建 start_backend.bat
cat > start_backend.bat << 'EOF'
@echo off
call venv\Scripts\activate
uvicorn src.web.app:app --host 0.0.0.0 --port 8000 --workers 4
EOF
```

---

## 🎨 步骤4: 前端部署

### 4.1 安装依赖

```bash
cd frontend
npm install
```

### 4.2 配置API地址

编辑 `frontend/src/services/api.ts`:

```typescript
// 生产环境API地址
const BASE_URL = process.env.NODE_ENV === 'production' 
    ? 'http://服务器IP:8000'   // 实际服务器地址
    : 'http://localhost:8000'
```

或者编辑 `frontend/vite.config.ts` 添加代理：

```typescript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  }
})
```

### 4.3 构建生产版本

```bash
# 构建前端
npm run build

# 构建产物在 frontend/dist 目录
ls dist/
```

### 4.4 配置前端服务

#### 方案A: 使用Nginx（推荐）

```bash
# 安装Nginx (如果未安装)
# Windows: 下载 http://nginx.org/en/download.html
# Linux: sudo apt install nginx

# 编辑Nginx配置
# Windows: C:\nginx\conf\nginx.conf
# Linux: /etc/nginx/sites-available/ai-calligraphy.conf

server {
    listen 80;
    server_name 服务器IP或域名;
    
    # 前端静态文件
    root D:/Production/AI-Calligraphy/frontend/dist;  # Windows路径
    # root /opt/ai-calligraphy/frontend/dist;          # Linux路径
    index index.html;
    
    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 后端API代理
    location /api {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# 重启Nginx
# Windows: nginx.exe -s reload
# Linux: sudo systemctl restart nginx
```

#### 方案B: 使用Node.js serve（简单方案）

```bash
# 安装serve
npm install -g serve

# 启动前端服务
serve -s frontend/dist -l 3000

# 或创建启动脚本
# start_frontend.sh (Linux)
#!/bin/bash
serve -s frontend/dist -l 3000

# start_frontend.bat (Windows)
@echo off
serve -s frontend/dist -l 3000
```

---

## 🔄 步骤5: 扫描仪集成（可选）

### 5.1 连接扫描仪

1. 将USB扫描仪连接到服务器
2. 安装扫描仪驱动程序
3. 配置扫描仪输出目录

### 5.2 配置监控服务

编辑 `src/web/scanner/watcher.py`:

```python
# 扫描仪输出目录
SCAN_DIRECTORY = r"D:\Scans"  # Windows
# SCAN_DIRECTORY = "/mnt/scans"  # Linux

# 支持的图片格式
SUPPORTED_FORMATS = ['.jpg', '.jpeg', '.png', '.bmp']
```

### 5.3 启动监控服务

```bash
# 创建监控启动脚本
# start_scanner.bat (Windows)
@echo off
call venv\Scripts\activate
python src/web/scanner/watcher.py

# start_scanner.sh (Linux)
#!/bin/bash
source venv/bin/activate
python src/web/scanner/watcher.py
```

---

## 🔐 步骤6: 系统服务配置

### Windows - 使用NSSM创建服务

```powershell
# 下载NSSM
# https://nssm.cc/download

# 安装后端服务
nssm install AICalligraphyBackend "D:\Production\AI-Calligraphy\venv\Scripts\python.exe" "D:\Production\AI-Calligraphy\run_web.py"
nssm set AICalligraphyBackend AppDirectory "D:\Production\AI-Calligraphy"
nssm start AICalligraphyBackend

# 安装扫描监控服务
nssm install ScannerWatcher "D:\Production\AI-Calligraphy\start_scanner.bat"
nssm start ScannerWatcher

# 查看服务状态
nssm status AICalligraphyBackend
```

### Linux - 使用Systemd

创建 `/etc/systemd/system/ai-calligraphy-backend.service`:

```ini
[Unit]
Description=AI Calligraphy Backend Service
After=network.target mysql.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/ai-calligraphy
ExecStart=/opt/ai-calligraphy/start_backend.sh
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务:

```bash
sudo systemctl daemon-reload
sudo systemctl enable ai-calligraphy-backend
sudo systemctl start ai-calligraphy-backend
sudo systemctl status ai-calligraphy-backend
```

类似地创建扫描监控服务。

---

## ✅ 步骤7: 验证部署

### 7.1 检查服务状态

```bash
# 检查后端
curl http://localhost:8000/docs
# 应该返回API文档页面

# 检查前端
curl http://localhost （Nginx）或 http://localhost:3000 (serve)
# 应该返回HTML

# 检查数据库连接
mysql -u eval_admin -p -e "USE calligraphy_ai; SELECT COUNT(*) FROM users;"
```

### 7.2 功能测试清单

1. **登录测试**
   - 访问前端页面
   - 使用admin/admin123登录
   - 检查是否进入管理员仪表盘

2. **数据管理测试**
   - 创建测试学期
   - 创建测试班级
   - 添加测试学生
   - 创建评价指标

3. **教师功能测试**
   - 创建教师账号
   - 分配班级
   - 测试数据录入
   - 测试AI评语生成

4. **学生查询测试**
   - 使用学号+姓名查询
   - 查看雷达图
   - 查看评语

### 7.3 性能测试

```bash
# 使用ab进行简单压力测试
ab -n 1000 -c 10 http://localhost:8000/api/auth/login

# 查看响应时间和并发性能
```

---

## 📊 步骤8: 监控与日志

### 8.1 配置日志

创建 `logs` 目录:

```bash
mkdir logs
```

编辑 `src/web/app.py` 添加日志配置:

```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/app.log'),
        logging.StreamHandler()
    ]
)
```

### 8.2 监控方案

- **系统资源**: 使用`htop`(Linux) 或 任务管理器(Windows)
- **数据库**: MySQL Slow Query Log
- **应用日志**: 定期检查 `logs/` 目录

---

## 🔒 步骤9: 安全加固

### 9.1 数据库安全

```sql
-- 删除默认账号
DELETE FROM mysql.user WHERE User='';
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1');

-- 修改root密码
ALTER USER 'root'@'localhost' IDENTIFIED BY '强壮密码@2024';
FLUSH PRIVILEGES;
```

### 9.2 防火墙配置

```bash
# Linux - UFW
sudo ufw allow 80/tcp      # HTTP
sudo ufw allow 443/tcp     # HTTPS (如果使用)
sudo ufw enable

# Windows - 打开Windows Defender防火墙
# 允许端口 80, 443
```

### 9.3 JWT密钥配置

编辑 `src/web/auth/jwt.py`:

```python
# 生成强随机密钥
import secrets
SECRET_KEY = secrets.token_urlsafe(32)  # 保存此密钥！
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 480  # 8小时
```

---

## 🔄 步骤10: 备份策略

### 10.1 数据库自动备份

创建备份脚本 `backup_db.sh` (Linux):

```bash
#!/bin/bash
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
FILENAME="calligraphy_ai_$DATE.sql"

mysqldump -u root -p密码 calligraphy_ai > "$BACKUP_DIR/$FILENAME"

# 压缩
gzip "$BACKUP_DIR/$FILENAME"

# 删除7天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
```

设置cron任务:

```bash
# 每天凌晨2点备份
0 2 * * * /path/to/backup_db.sh
```

### 10.2 文件备份

定期备份以下目录:
- `data/` - 上传的图片
- `logs/` - 日志文件
- 配置文件

---

## 📱 步骤11: 用户培训

### 11.1 管理员培训内容

1. 系统初始配置
2. 学期和班级管理
3. 用户账号管理
4. 评价指标配置
5. 数据备份与恢复

### 11.2 教师培训内容

1. 登录系统
2. 数据录入操作
3. AI评语生成与编辑
4. 书法作品批改查看
5. 常见问题处理

### 11.3 学生/家长使用指导

1. 如何查询评价结果
2. 雷达图解读
3. 评语查看
4. 书法成绩查询

---

## 🆘 常见问题排查

### 问题1: 后端无法启动

```bash
# 检查Python版本
python --version  # 应>=3.9

# 检查依赖
pip list

# 查看错误日志
tail -f logs/error.log

# 检查数据库连接
mysql -u eval_admin -p calligraphy_ai
```

### 问题2: 前端白屏

```bash
# 检查构建产物
ls frontend/dist

# 检查Nginx配置
nginx -t

# 查看浏览器控制台
# F12 -> Console 查看错误
```

### 问题3: AI评语生成失败

```python
# 检查千问API
# 在Python中测试
from src.api.qwen_client import QwenClient
client = QwenClient()
response = client.chat("测试")
print(response)
```

### 问题4: 扫描仪不工作

```bash
# 检查扫描仪连接
# Windows: 设备管理器
# Linux: lsusb

# 检查监控服务
# 查看日志
tail -f logs/scanner.log
```

---

## 📞 技术支持

遇到问题请按以下顺序排查:

1. **查看日志**: `logs/` 目录下的日志文件
2. **检查配置**: 数据库连接、API密钥等配置
3. **查阅文档**: 本部署指南和系统使用指南
4. **联系开发者**: 提供详细的错误日志和环境信息

---

## ✅ 部署完成检查清单

- [ ] MySQL数据库正常运行
- [ ] 后端服务正常启动 (端口8000)
- [ ] 前端服务正常访问 (端口80或3000)
- [ ] 管理员账号可以登录
- [ ] 教师数据录入功能正常
- [ ] AI评语生成功能正常
- [ ] 学生查询功能正常
- [ ] 扫描仪监控服务正常（如需要）
- [ ] 数据库备份计划已配置
- [ ] 防火墙规则已配置
- [ ] 用户培训已完成

---

<div align="center">

**祝部署顺利！** 🎉

如有问题，请参考文档或联系技术支持团队。

</div>
